#!/bin/bash
# HURRICANE v6-gatewayd Unified Control Script
# Manages v6-gatewayd daemon, comprehensive API, and all services

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" 2>/dev/null && pwd)"
PID_FILE="${SCRIPT_DIR}/.hurricane.pid"
LOG_DIR="${SCRIPT_DIR}/logs"
CONFIG_DIR="${SCRIPT_DIR}/config"
CONFIG_FILE="${CONFIG_DIR}/v6-gatewayd.conf"
V6_GATEWAYD_BIN="${SCRIPT_DIR}/target/release/v6-gatewayd"
COMPREHENSIVE_API="${SCRIPT_DIR}/scripts/comprehensive-api.py"
WEB_DIR="${SCRIPT_DIR}/web"
PYTHON_BIN="python3"

if [ -x "${SCRIPT_DIR}/.venv/bin/python" ]; then
    PYTHON_BIN="${SCRIPT_DIR}/.venv/bin/python"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Create log directory
mkdir -p "$LOG_DIR"

# Helper functions
print_banner() {
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║           HURRICANE v6-gatewayd Control Center            ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
}

print_status() {
    local status=$1
    local message=$2
    if [ "$status" = "ok" ]; then
        echo -e "  ${GREEN}✓${NC} $message"
    elif [ "$status" = "warn" ]; then
        echo -e "  ${YELLOW}⚠${NC} $message"
    elif [ "$status" = "error" ]; then
        echo -e "  ${RED}✗${NC} $message"
    else
        echo -e "  ${BLUE}ℹ${NC} $message"
    fi
}

check_binary() {
    if [ ! -f "$V6_GATEWAYD_BIN" ]; then
        echo -e "${RED}Error: v6-gatewayd binary not found${NC}"
        echo "Run 'make build' first to compile the daemon"
        exit 1
    fi
}

check_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Warning: Config file not found at $CONFIG_FILE${NC}"
    fi
}

# PID management
save_pid() {
    local name=$1
    local pid=$2
    echo "${name}=${pid}" >> "$PID_FILE"
}

get_pid() {
    local name=$1
    if [ -f "$PID_FILE" ]; then
        grep "^${name}=" "$PID_FILE" 2>/dev/null | cut -d'=' -f2
    fi
}

clear_pids() {
    rm -f "$PID_FILE"
}

is_running() {
    local pid=$1
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Start function
start_services() {
    print_banner
    echo ""
    echo -e "${CYAN}Starting HURRICANE services...${NC}"
    echo ""

    # Check if already running
    if [ -f "$PID_FILE" ]; then
        local daemon_pid=$(get_pid "daemon")
        local api_pid=$(get_pid "api")

        if is_running "$daemon_pid" || is_running "$api_pid"; then
            echo -e "${YELLOW}Services already running. Use 'hurricane restart' to restart.${NC}"
            status_services
            exit 0
        else
            clear_pids
        fi
    fi

    check_binary
    check_config

    # Start v6-gatewayd daemon
    echo -e "${BLUE}[1/2] Starting v6-gatewayd daemon...${NC}"
    "$V6_GATEWAYD_BIN" --config "$CONFIG_FILE" > "$LOG_DIR/v6-gatewayd.log" 2>&1 &
    local daemon_pid=$!
    sleep 2

    if is_running "$daemon_pid"; then
        save_pid "daemon" "$daemon_pid"
        print_status "ok" "v6-gatewayd daemon started (PID: $daemon_pid)"
        print_status "info" "Listening on http://127.0.0.1:8642"
    else
        print_status "error" "Failed to start v6-gatewayd daemon"
        echo -e "${RED}Check logs: $LOG_DIR/v6-gatewayd.log${NC}"
        exit 1
    fi

    # Start comprehensive API
    echo -e "${BLUE}[2/2] Starting comprehensive API server...${NC}"
    if [ -f "$COMPREHENSIVE_API" ]; then
        "$PYTHON_BIN" "$COMPREHENSIVE_API" > "$LOG_DIR/comprehensive-api.log" 2>&1 &
        local api_pid=$!
        sleep 2

        if is_running "$api_pid"; then
            save_pid "api" "$api_pid"
            print_status "ok" "Comprehensive API started (PID: $api_pid)"
            print_status "info" "Listening on http://127.0.0.1:8643"
        else
            print_status "error" "Failed to start comprehensive API"
            echo -e "${RED}Check logs: $LOG_DIR/comprehensive-api.log${NC}"
            # Kill daemon if API fails
            kill "$daemon_pid" 2>/dev/null || true
            clear_pids
            exit 1
        fi
    else
        print_status "warn" "Comprehensive API script not found, skipping"
    fi

    echo ""
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║              All Services Started Successfully            ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${CYAN}Access points:${NC}"
    echo -e "  ${BOLD}WebUI:${NC}              ${GREEN}http://127.0.0.1:8643${NC}"
    echo -e "  ${BOLD}Daemon API:${NC}         ${BLUE}http://127.0.0.1:8642${NC}"
    echo -e "  ${BOLD}Prometheus metrics:${NC} ${BLUE}http://127.0.0.1:8642/metrics${NC}"
    echo ""
    echo -e "${CYAN}Logs:${NC}"
    echo -e "  ${BOLD}Daemon:${NC}  $LOG_DIR/v6-gatewayd.log"
    echo -e "  ${BOLD}API:${NC}     $LOG_DIR/comprehensive-api.log"
    echo ""
    echo -e "${YELLOW}Use 'hurricane status' to check service health${NC}"
    echo -e "${YELLOW}Use 'hurricane stop' to shutdown all services${NC}"
    echo ""
}

# Stop function
stop_services() {
    print_banner
    echo ""
    echo -e "${CYAN}Stopping HURRICANE services...${NC}"
    echo ""

    if [ ! -f "$PID_FILE" ]; then
        echo -e "${YELLOW}No services running (PID file not found)${NC}"
        exit 0
    fi

    local daemon_pid=$(get_pid "daemon")
    local api_pid=$(get_pid "api")
    local stopped=0

    # Stop comprehensive API
    if [ -n "$api_pid" ] && is_running "$api_pid"; then
        echo -e "${BLUE}Stopping comprehensive API (PID: $api_pid)...${NC}"
        kill "$api_pid" 2>/dev/null || true
        sleep 1
        if ! is_running "$api_pid"; then
            print_status "ok" "Comprehensive API stopped"
            stopped=$((stopped + 1))
        else
            kill -9 "$api_pid" 2>/dev/null || true
            print_status "warn" "Comprehensive API force-killed"
            stopped=$((stopped + 1))
        fi
    fi

    # Stop v6-gatewayd daemon
    if [ -n "$daemon_pid" ] && is_running "$daemon_pid"; then
        echo -e "${BLUE}Stopping v6-gatewayd daemon (PID: $daemon_pid)...${NC}"
        kill "$daemon_pid" 2>/dev/null || true
        sleep 2
        if ! is_running "$daemon_pid"; then
            print_status "ok" "v6-gatewayd daemon stopped"
            stopped=$((stopped + 1))
        else
            kill -9 "$daemon_pid" 2>/dev/null || true
            print_status "warn" "v6-gatewayd daemon force-killed"
            stopped=$((stopped + 1))
        fi
    fi

    clear_pids

    if [ $stopped -eq 0 ]; then
        echo -e "${YELLOW}No running services found${NC}"
    else
        echo ""
        echo -e "${GREEN}All services stopped successfully${NC}"
    fi
    echo ""
}

# Status function
status_services() {
    print_banner
    echo ""
    echo -e "${CYAN}Service Status:${NC}"
    echo ""

    if [ ! -f "$PID_FILE" ]; then
        print_status "warn" "No services running (PID file not found)"
        echo ""
        return
    fi

    local daemon_pid=$(get_pid "daemon")
    local api_pid=$(get_pid "api")
    local all_running=true

    # Check v6-gatewayd daemon
    echo -e "${BOLD}v6-gatewayd Daemon:${NC}"
    if [ -n "$daemon_pid" ] && is_running "$daemon_pid"; then
        print_status "ok" "Running (PID: $daemon_pid)"
        print_status "info" "API: http://127.0.0.1:8642"

        # Try to get health status
        if command -v curl &> /dev/null; then
            local health=$(curl -s http://127.0.0.1:8642/health 2>/dev/null || echo "")
            if [ -n "$health" ]; then
                local status=$(echo "$health" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
                print_status "info" "Health: $status"
            fi
        fi
    else
        print_status "error" "Not running"
        all_running=false
    fi

    echo ""

    # Check comprehensive API
    echo -e "${BOLD}Comprehensive API:${NC}"
    if [ -n "$api_pid" ] && is_running "$api_pid"; then
        print_status "ok" "Running (PID: $api_pid)"
        print_status "info" "WebUI: http://127.0.0.1:8643"

        # Try to get routing status
        if command -v curl &> /dev/null; then
            local routing=$(curl -s http://127.0.0.1:8643/routing/status 2>/dev/null || echo "")
            if [ -n "$routing" ]; then
                local mode=$(echo "$routing" | grep -o '"routing_mode":"[^"]*"' | cut -d'"' -f4)
                print_status "info" "Routing mode: $mode"
            fi
        fi
    else
        print_status "error" "Not running"
        all_running=false
    fi

    echo ""

    # Overall status
    if $all_running; then
        echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║              All Services Operational                     ║${NC}"
        echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    else
        echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${RED}║              Some Services Not Running                    ║${NC}"
        echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    fi
    echo ""
}

# Restart function
restart_services() {
    stop_services
    sleep 2
    start_services
}

# Logs function
show_logs() {
    local service=$1

    print_banner
    echo ""

    case "$service" in
        daemon)
            echo -e "${CYAN}v6-gatewayd Daemon Logs (last 50 lines):${NC}"
            echo -e "${BLUE}────────────────────────────────────────────────────────────${NC}"
            tail -n 50 "$LOG_DIR/v6-gatewayd.log" 2>/dev/null || echo "No logs found"
            ;;
        api)
            echo -e "${CYAN}Comprehensive API Logs (last 50 lines):${NC}"
            echo -e "${BLUE}────────────────────────────────────────────────────────────${NC}"
            tail -n 50 "$LOG_DIR/comprehensive-api.log" 2>/dev/null || echo "No logs found"
            ;;
        all|*)
            echo -e "${CYAN}Recent Logs from All Services:${NC}"
            echo ""
            echo -e "${BOLD}v6-gatewayd Daemon:${NC}"
            echo -e "${BLUE}────────────────────────────────────────────────────────────${NC}"
            tail -n 25 "$LOG_DIR/v6-gatewayd.log" 2>/dev/null || echo "No logs found"
            echo ""
            echo -e "${BOLD}Comprehensive API:${NC}"
            echo -e "${BLUE}────────────────────────────────────────────────────────────${NC}"
            tail -n 25 "$LOG_DIR/comprehensive-api.log" 2>/dev/null || echo "No logs found"
            ;;
    esac
    echo ""
}

# Help function
show_help() {
    print_banner
    echo ""
    echo -e "${CYAN}Usage:${NC}"
    echo -e "  ${BOLD}hurricane${NC} ${GREEN}<command>${NC} [options]"
    echo ""
    echo -e "${CYAN}Commands:${NC}"
    echo -e "  ${GREEN}start${NC}              Start all HURRICANE services"
    echo -e "  ${GREEN}stop${NC}               Stop all HURRICANE services"
    echo -e "  ${GREEN}restart${NC}            Restart all HURRICANE services"
    echo -e "  ${GREEN}status${NC}             Show status of all services"
    echo -e "  ${GREEN}logs${NC} [service]     Show logs (daemon|api|all)"
    echo -e "  ${GREEN}help${NC}               Show this help message"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  ${BOLD}hurricane start${NC}         # Start all services"
    echo -e "  ${BOLD}hurricane status${NC}        # Check service status"
    echo -e "  ${BOLD}hurricane logs daemon${NC}   # View daemon logs"
    echo -e "  ${BOLD}hurricane restart${NC}       # Restart everything"
    echo ""
    echo -e "${CYAN}Services Managed:${NC}"
    echo -e "  • v6-gatewayd daemon (port 8642)"
    echo -e "  • Comprehensive API server (port 8643)"
    echo -e "  • Routing mode controller (IPv6/IPv9/Dual)"
    echo -e "  • Split tunneling manager"
    echo -e "  • FASTPORT unified scanner"
    echo -e "  • WebUI interface"
    echo ""
}

# Main command dispatcher
case "${1:-}" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    status)
        status_services
        ;;
    logs)
        show_logs "${2:-all}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '${1:-}'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
